{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Security Dashboard - David Johnson Foundation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">Security & Compliance Dashboard</h2>
                    <p class="text-muted mb-0">System security monitoring and compliance oversight</p>
                </div>
                <div>
                    <a href="{% url 'grants:audit_log_view' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-list"></i> View Audit Log
                    </a>
                    <a href="{% url 'grants:compliance_report' %}" class="btn btn-primary">
                        <i class="fas fa-file-alt"></i> Compliance Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Overview Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">Compliance Score</h6>
                            <h3 class="mb-0">{{ compliance_score }}%</h3>
                            <small class="opacity-75">
                                {% if compliance_score >= 90 %}Excellent
                                {% elif compliance_score >= 80 %}Good
                                {% elif compliance_score >= 70 %}Fair
                                {% else %}Needs Attention{% endif %}
                            </small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-shield-alt fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">Active Sessions</h6>
                            <h3 class="mb-0">{{ total_logins_today }}</h3>
                            <small class="opacity-75">Today's login activity</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card bg-{% if failed_login_attempts > 10 %}danger{% elif failed_login_attempts > 5 %}warning{% else %}success{% endif %} text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">Failed Logins</h6>
                            <h3 class="mb-0">{{ failed_login_attempts }}</h3>
                            <small class="opacity-75">Last 7 days</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="card bg-{% if suspicious_activities > 0 %}danger{% else %}success{% endif %} text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="mb-0">Security Alerts</h6>
                            <h3 class="mb-0">{{ suspicious_activities }}</h3>
                            <small class="opacity-75">Last 30 days</small>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-bell fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Issues -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Compliance Issues</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                <div>
                                    <h6 class="mb-0">Missing Application Data</h6>
                                    <small class="text-muted">Incomplete application records</small>
                                </div>
                                <span class="badge bg-{% if applications_with_missing_data > 0 %}warning{% else %}success{% endif %} fs-6">
                                    {{ applications_with_missing_data }}
                                </span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                <div>
                                    <h6 class="mb-0">Overdue Reports</h6>
                                    <small class="text-muted">Progress reports past due</small>
                                </div>
                                <span class="badge bg-{% if overdue_reports > 0 %}danger{% else %}success{% endif %} fs-6">
                                    {{ overdue_reports }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                <div>
                                    <h6 class="mb-0">Unverified Documents</h6>
                                    <small class="text-muted">Documents awaiting verification</small>
                                </div>
                                <span class="badge bg-{% if unverified_documents > 5 %}warning{% else %}success{% endif %} fs-6">
                                    {{ unverified_documents }}
                                </span>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                                <div>
                                    <h6 class="mb-0">System Health</h6>
                                    <small class="text-muted">Overall system status</small>
                                </div>
                                <span class="badge bg-success fs-6">
                                    Operational
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    {% if applications_with_missing_data > 0 or overdue_reports > 0 or unverified_documents > 0 %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Action Required:</strong> There are compliance issues that need attention.
                        <a href="{% url 'grants:compliance_report' %}" class="alert-link">View detailed report</a>
                    </div>
                    {% else %}
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle"></i>
                        <strong>All Clear:</strong> No compliance issues detected.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Security Score</h5>
                </div>
                <div class="card-body text-center">
                    <div class="position-relative d-inline-block">
                        <canvas id="securityScoreChart" width="150" height="150"></canvas>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <h3 class="mb-0">{{ compliance_score|floatformat:0 }}%</h3>
                            <small class="text-muted">Security Score</small>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        {% if compliance_score >= 90 %}
                            <div class="alert alert-success">
                                <i class="fas fa-shield-alt"></i> Excellent security posture
                            </div>
                        {% elif compliance_score >= 80 %}
                            <div class="alert alert-warning">
                                <i class="fas fa-shield-alt"></i> Good security with room for improvement
                            </div>
                        {% else %}
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> Security improvements needed
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Audit Activity -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Audit Activity</h5>
                    <a href="{% url 'grants:audit_log_view' %}" class="btn btn-sm btn-outline-primary">
                        View All <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                    <th>IP Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for audit in recent_audits %}
                                <tr class="{% if audit.action in 'failed_login,unauthorized_access,suspicious_activity' %}table-warning{% endif %}">
                                    <td>{{ audit.timestamp|date:"M d, Y H:i" }}</td>
                                    <td>
                                        {% if audit.user %}
                                            {{ audit.user.get_full_name|default:audit.user.username }}
                                        {% else %}
                                            <span class="text-muted">System</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{% if audit.action == 'failed_login' %}danger{% elif audit.action in 'login,document_uploaded,application_submitted' %}success{% elif audit.action in 'unauthorized_access,suspicious_activity' %}warning{% else %}secondary{% endif %}">
                                            {{ audit.action|title }}
                                        </span>
                                    </td>
                                    <td>{{ audit.details|truncatechars:60 }}</td>
                                    <td><code>{{ audit.ip_address|default:"N/A" }}</code></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No recent audit activity</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.1);
}

.border {
    transition: all 0.2s ease;
}

.border:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Security Score Doughnut Chart
const securityCtx = document.getElementById('securityScoreChart').getContext('2d');
const securityChart = new Chart(securityCtx, {
    type: 'doughnut',
    data: {
        datasets: [{
            data: [{{ compliance_score }}, {{ 100|add:compliance_score|add:"-100" }}],
            backgroundColor: [
                {% if compliance_score >= 90 %}'#28a745'{% elif compliance_score >= 80 %}'#ffc107'{% else %}'#dc3545'{% endif %},
                '#e9ecef'
            ],
            borderWidth: 0,
            cutout: '75%'
        }]
    },
    options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                enabled: false
            }
        }
    }
});

// Auto-refresh security data every 30 seconds
setInterval(function() {
    fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            // Update specific metrics without full page reload
            console.log('Security data refreshed');
        }
    })
    .catch(error => console.log('Auto-refresh failed:', error));
}, 30000);
</script>
{% endblock %}