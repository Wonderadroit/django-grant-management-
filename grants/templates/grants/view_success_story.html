{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}{{ success_story.title }} - Success Stories{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <!-- Story Header -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-success text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-1">
                                <i class="fas fa-star me-2"></i>{{ success_story.title }}
                            </h3>
                            <p class="mb-0">
                                <i class="fas fa-user"></i> {{ success_story.application.applicant_name }} â€¢ 
                                <i class="fas fa-calendar"></i> {{ success_story.created_at|date:"F d, Y" }}
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <span class="badge bg-light text-dark fs-6">
                                <i class="fas fa-dollar-sign"></i> ${{ success_story.application.approved_amount|default:success_story.application.amount_requested|floatformat:0 }} Grant
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Project Info -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h5><i class="fas fa-project-diagram text-primary"></i> Project Details</h5>
                            <h6>{{ success_story.application.project_title }}</h6>
                            <p class="text-muted">{{ success_story.application.project_description }}</p>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light p-3 rounded">
                                <h6><i class="fas fa-map-marker-alt text-info"></i> Location</h6>
                                <p class="mb-1">{{ success_story.application.organization_name }}</p>
                                <p class="mb-0 text-muted">
                                    {{ success_story.application.organization_address|default:"Location not specified" }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Story Content -->
            <div class="row">
                <!-- Story Text -->
                <div class="col-md-8">
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-book-open text-primary"></i> Success Story</h5>
                        </div>
                        <div class="card-body">
                            <div class="story-content">
                                {{ success_story.story|linebreaks }}
                            </div>
                        </div>
                    </div>

                    <!-- Impact Section -->
                    <div class="card shadow mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Impact & Results</h5>
                        </div>
                        <div class="card-body">
                            <div class="impact-content">
                                {{ success_story.impact_description|linebreaks }}
                            </div>
                        </div>
                    </div>

                    <!-- Video Section -->
                    {% if success_story.video_url %}
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-video text-danger"></i> Video Testimonial</h5>
                        </div>
                        <div class="card-body">
                            <div class="ratio ratio-16x9">
                                {% if 'youtube.com' in success_story.video_url or 'youtu.be' in success_story.video_url %}
                                    {% with success_story.video_url|cut:'https://www.youtube.com/watch?v='|cut:'https://youtu.be/' as video_id %}
                                    <iframe src="https://www.youtube.com/embed/{{ video_id }}" 
                                            title="Success Story Video" 
                                            allowfullscreen></iframe>
                                    {% endwith %}
                                {% elif 'vimeo.com' in success_story.video_url %}
                                    {% with success_story.video_url|cut:'https://vimeo.com/' as video_id %}
                                    <iframe src="https://player.vimeo.com/video/{{ video_id }}" 
                                            title="Success Story Video" 
                                            allowfullscreen></iframe>
                                    {% endwith %}
                                {% else %}
                                    <div class="text-center p-4">
                                        <a href="{{ success_story.video_url }}" target="_blank" class="btn btn-primary">
                                            <i class="fas fa-external-link-alt"></i> Watch Video
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Sidebar with Images -->
                <div class="col-md-4">
                    {% if success_story.images.exists %}
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-images text-success"></i> Photo Gallery</h5>
                        </div>
                        <div class="card-body p-2">
                            <!-- Primary Image -->
                            {% with success_story.images.filter:is_primary=True.first as primary_image %}
                            {% if primary_image %}
                            <div class="mb-3">
                                <img src="{{ primary_image.image.url }}" 
                                     class="img-fluid rounded shadow-sm" 
                                     alt="{{ primary_image.alt_text }}"
                                     data-bs-toggle="modal" 
                                     data-bs-target="#imageModal{{ primary_image.id }}"
                                     style="cursor: pointer; width: 100%;">
                                {% if primary_image.caption %}
                                <p class="mt-2 mb-0 text-muted small">
                                    <i class="fas fa-star text-warning"></i> {{ primary_image.caption }}
                                </p>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endwith %}

                            <!-- Additional Images -->
                            {% for image in success_story.images.filter:is_primary=False %}
                            <div class="mb-3">
                                <img src="{{ image.image.url }}" 
                                     class="img-fluid rounded shadow-sm" 
                                     alt="{{ image.alt_text }}"
                                     data-bs-toggle="modal" 
                                     data-bs-target="#imageModal{{ image.id }}"
                                     style="cursor: pointer; width: 100%;">
                                {% if image.caption %}
                                <p class="mt-2 mb-0 text-muted small">{{ image.caption }}</p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Share Section -->
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-share-alt text-info"></i> Share This Story</h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="shareOnFacebook()">
                                    <i class="fab fa-facebook-f"></i> Share on Facebook
                                </button>
                                <button class="btn btn-info" onclick="shareOnTwitter()">
                                    <i class="fab fa-twitter"></i> Share on Twitter
                                </button>
                                <button class="btn btn-success" onclick="shareOnWhatsApp()">
                                    <i class="fab fa-whatsapp"></i> Share on WhatsApp
                                </button>
                                <button class="btn btn-outline-secondary" onclick="copyLink()">
                                    <i class="fas fa-link"></i> Copy Link
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Related Info -->
                    <div class="card shadow">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle text-warning"></i> About This Grant</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Application Date:</strong><br>
                               {{ success_story.application.created_at|date:"F d, Y" }}</p>
                            
                            {% if success_story.application.approval_date %}
                            <p><strong>Approval Date:</strong><br>
                               {{ success_story.application.approval_date|date:"F d, Y" }}</p>
                            {% endif %}
                            
                            <p><strong>Grant Type:</strong><br>
                               {{ success_story.application.grant_type|default:"General Grant" }}</p>
                            
                            <a href="{% url 'grants:success_stories' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-arrow-left"></i> All Success Stories
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modals -->
{% for image in success_story.images.all %}
<div class="modal fade" id="imageModal{{ image.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if image.caption %}{{ image.caption }}{% else %}Photo from {{ success_story.title }}{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="{{ image.image.url }}" 
                     class="img-fluid" 
                     alt="{{ image.alt_text }}"
                     style="max-height: 70vh;">
                {% if image.caption and image.alt_text != image.caption %}
                <p class="mt-3 text-muted">{{ image.alt_text }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<style>
.story-content, .impact-content {
    font-size: 1.1rem;
    line-height: 1.8;
}

.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.img-fluid[data-bs-toggle="modal"] {
    transition: transform 0.2s ease;
}

.img-fluid[data-bs-toggle="modal"]:hover {
    transform: scale(1.02);
}

.badge {
    font-size: 0.9rem;
}
</style>

<script>
function shareOnFacebook() {
    const url = encodeURIComponent(window.location.href);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareOnTwitter() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('Check out this inspiring success story from the David Johnson Foundation!');
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareOnWhatsApp() {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent('Check out this inspiring success story from the David Johnson Foundation! ');
    window.open(`https://wa.me/?text=${text}${url}`, '_blank');
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(function() {
        // Show success message
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        
        setTimeout(function() {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}
</script>
{% endblock %}