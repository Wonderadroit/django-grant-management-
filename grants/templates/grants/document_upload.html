{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Document Upload - David Johnson Foundation{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-upload me-2"></i>
                        Document Upload - Step 3 of 7
                    </h4>
                </div>
                
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="progress mb-4" style="height: 20px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 43%;" aria-valuenow="43" aria-valuemin="0" aria-valuemax="100">
                            43% Complete
                        </div>
                    </div>
                    
                    <!-- Stage Navigation -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-success">Eligibility ✓</span>
                            <span class="badge bg-success">Details ✓</span>
                            <span class="badge bg-primary">Documents</span>
                            <span class="badge bg-secondary">Review</span>
                            <span class="badge bg-secondary">Interview</span>
                            <span class="badge bg-secondary">Decision</span>
                            <span class="badge bg-secondary">Complete</span>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Please upload the required documents to support your application. All files must be in PDF, DOC, DOCX, JPG, JPEG, PNG, or TXT format and not exceed 10MB.
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" enctype="multipart/form-data" id="documentForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-3">Required Documents</h5>
                                
                                {% for doc_type in required_documents %}
                                <div class="document-section mb-4 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            {{ doc_type.name }}
                                            {% if doc_type.required %}
                                                <span class="text-danger">*</span>
                                            {% endif %}
                                        </h6>
                                        <span class="document-status" data-type="{{ doc_type.id }}">
                                            {% if doc_type.id in uploaded_docs %}
                                                {% if uploaded_docs|get_item:doc_type.id.verified %}
                                                    <span class="badge bg-success">Verified ✓</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Under Review</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-secondary">Not Uploaded</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    <p class="text-muted small mb-2">{{ doc_type.description }}</p>
                                    
                                    <div class="mb-2">
                                        <input type="file" 
                                               class="form-control document-upload" 
                                               name="document_{{ doc_type.id }}" 
                                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
                                               data-type-id="{{ doc_type.id }}"
                                               data-type-name="{{ doc_type.name }}">
                                    </div>
                                    
                                    {% if doc_type.id in uploaded_docs %}
                                    <div class="current-file">
                                        <small class="text-success">
                                            <i class="fas fa-file"></i>
                                            Current: {{ uploaded_docs|get_item:doc_type.id.file.name|default:"Unknown file" }}
                                            <a href="{{ uploaded_docs|get_item:doc_type.id.file.url }}" target="_blank" class="ms-2">
                                                <i class="fas fa-external-link-alt"></i> View
                                            </a>
                                        </small>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="upload-progress" data-type="{{ doc_type.id }}" style="display: none;">
                                        <div class="progress mt-2" style="height: 10px;">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="mb-3">Optional Documents</h5>
                                
                                {% for doc_type in optional_documents %}
                                <div class="document-section mb-4 p-3 border rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">{{ doc_type.name }}</h6>
                                        <span class="document-status" data-type="{{ doc_type.id }}">
                                            {% if doc_type.id in uploaded_docs %}
                                                {% if uploaded_docs|get_item:doc_type.id.verified %}
                                                    <span class="badge bg-success">Verified ✓</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Under Review</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="badge bg-light">Optional</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                    
                                    <p class="text-muted small mb-2">{{ doc_type.description }}</p>
                                    
                                    <div class="mb-2">
                                        <input type="file" 
                                               class="form-control document-upload" 
                                               name="document_{{ doc_type.id }}" 
                                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
                                               data-type-id="{{ doc_type.id }}"
                                               data-type-name="{{ doc_type.name }}">
                                    </div>
                                    
                                    {% if doc_type.id in uploaded_docs %}
                                    <div class="current-file">
                                        <small class="text-success">
                                            <i class="fas fa-file"></i>
                                            Current: {{ uploaded_docs|get_item:doc_type.id.file.name|default:"Unknown file" }}
                                            <a href="{{ uploaded_docs|get_item:doc_type.id.file.url }}" target="_blank" class="ms-2">
                                                <i class="fas fa-external-link-alt"></i> View
                                            </a>
                                        </small>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="upload-progress" data-type="{{ doc_type.id }}" style="display: none;">
                                        <div class="progress mt-2" style="height: 10px;">
                                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Overall Upload Progress -->
                        <div class="mb-4" id="overallProgress" style="display: none;">
                            <h6>Upload Progress</h6>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 0%">
                                    <span class="progress-text">0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- Document Summary -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">Document Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="h4 text-success" id="uploadedCount">{{ uploaded_count }}</div>
                                            <small class="text-muted">Uploaded</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="h4 text-warning" id="pendingCount">{{ pending_count }}</div>
                                            <small class="text-muted">Under Review</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center">
                                            <div class="h4 text-primary" id="verifiedCount">{{ verified_count }}</div>
                                            <small class="text-muted">Verified</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'grants:application_details' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Details
                            </a>
                            
                            <div>
                                <button type="button" class="btn btn-outline-primary me-2" id="saveProgress">
                                    <i class="fas fa-save"></i> Save Progress
                                </button>
                                <button type="submit" class="btn btn-primary" id="continueToReview">
                                    Continue to Review <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Uploading Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Uploading...</span>
                    </div>
                    <p class="mt-3">Uploading <span id="uploadingFileName"></span>...</p>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%">
                            <span class="progress-text">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.document-section {
    transition: all 0.3s ease;
}

.document-section:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.document-upload {
    transition: border-color 0.3s ease;
}

.document-upload:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

.badge {
    font-size: 0.8em;
}

.progress-bar {
    transition: width 0.3s ease;
}

.card-header {
    border-bottom: 2px solid #007bff;
}

.current-file {
    background-color: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.25rem;
    border-left: 3px solid #28a745;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
    let uploadInProgress = false;

    // Handle file uploads
    document.querySelectorAll('.document-upload').forEach(input => {
        input.addEventListener('change', function() {
            if (this.files.length > 0) {
                uploadFile(this);
            }
        });
    });

    function uploadFile(input) {
        if (uploadInProgress) {
            alert('Please wait for the current upload to complete.');
            return;
        }

        const file = input.files[0];
        const typeId = input.dataset.typeId;
        const typeName = input.dataset.typeName;
        
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size cannot exceed 10MB.');
            input.value = '';
            return;
        }

        // Show upload modal
        document.getElementById('uploadingFileName').textContent = file.name;
        uploadModal.show();
        uploadInProgress = true;

        // Create FormData
        const formData = new FormData();
        formData.append('document', file);
        formData.append('document_type_id', typeId);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        // Upload with progress
        const xhr = new XMLHttpRequest();
        
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                const progressBar = document.querySelector('#uploadModal .progress-bar');
                const progressText = document.querySelector('#uploadModal .progress-text');
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
            }
        });

        xhr.addEventListener('load', function() {
            uploadInProgress = false;
            uploadModal.hide();
            
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    // Update status badge
                    const statusBadge = document.querySelector(`[data-type="${typeId}"] .badge`);
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.textContent = 'Under Review';
                    
                    // Show success message
                    showMessage('Document uploaded successfully!', 'success');
                    
                    // Update counters
                    updateDocumentCounters();
                } else {
                    showMessage(response.error || 'Upload failed. Please try again.', 'danger');
                    input.value = '';
                }
            } else {
                showMessage('Upload failed. Please try again.', 'danger');
                input.value = '';
            }
        });

        xhr.addEventListener('error', function() {
            uploadInProgress = false;
            uploadModal.hide();
            showMessage('Upload failed. Please check your connection and try again.', 'danger');
            input.value = '';
        });

        xhr.open('POST', '{% url "grants:upload_document" %}');
        xhr.send(formData);
    }

    function updateDocumentCounters() {
        // Update document summary counters via AJAX
        fetch('{% url "grants:get_document_status" %}')
            .then(response => response.json())
            .then(data => {
                let uploaded = 0, pending = 0, verified = 0;
                
                data.documents.forEach(doc => {
                    if (doc.uploaded) {
                        uploaded++;
                        if (doc.verified) {
                            verified++;
                        } else {
                            pending++;
                        }
                    }
                });
                
                document.getElementById('uploadedCount').textContent = uploaded;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('verifiedCount').textContent = verified;
            });
    }

    function showMessage(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const form = document.getElementById('documentForm');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Save progress button
    document.getElementById('saveProgress').addEventListener('click', function() {
        // Update application stage to 'documents'
        fetch('{% url "grants:update_application_stage" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                stage: 'documents'
            })
        }).then(response => {
            if (response.ok) {
                showMessage('Progress saved successfully!', 'success');
            }
        });
    });

    // Check document status on page load
    updateDocumentCounters();
});
</script>
{% endblock %}